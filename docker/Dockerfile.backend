# Stage 1: builder
FROM python:3.10.9-slim-bullseye as builder

WORKDIR /app

# Copy requirements
COPY requirements.txt requirements-langgraph.txt ./

# Cài gói vào thư mục riêng
RUN pip install --upgrade pip && \
    pip install --prefix=/install -r requirements.txt && \
    pip install --prefix=/install -r requirements-langgraph.txt

# Copy toàn bộ mã nguồn
COPY . .

# Stage 2: runtime
FROM python:3.10.9-slim-bullseye

# Tạo user không root
RUN useradd -m -u 1001 chatbotuser

# Tạo thư mục và gán quyền
RUN mkdir -p /app && chown -R chatbotuser:chatbotuser /app

# Copy từ builder
COPY --from=builder /install /usr/local
COPY --from=builder /app /app

# Copy entrypoint script và cấp quyền
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

# Chuyển sang user không root
USER chatbotuser
WORKDIR /app

# Mở cổng backend
EXPOSE 8000

# Lệnh khởi chạy
CMD ["./entrypoint.sh"]
